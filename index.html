<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Present Simple: –§–æ–Ω–∞—Ä–∏–∫ –∏ –õ–∞–∑–µ—Ä—ã</title>
    <style>
        /* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï === */
        body {
            margin: 0; padding: 0; background-color: #0b0c10; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; color: #fff; user-select: none;
        }

        #game-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        #game-container {
            width: 1280px; height: 720px;
            background: #1f2833;
            position: relative; transform-origin: center center;
            box-shadow: 0 0 30px #45a29e; border: 2px solid #66fcf1;
            border-radius: 15px; overflow: hidden;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .screen.active { display: flex; }

        h1 { font-size: 60px; color: #66fcf1; margin-bottom: 20px; text-shadow: 0 0 10px #45a29e; text-align: center;}
        h2 { font-size: 40px; color: #c5c6c7; margin-bottom: 15px; z-index: 10; text-align: center;}

        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            padding: 15px 35px; font-size: 26px; font-weight: bold; margin: 10px; cursor: pointer;
            border: 2px solid #66fcf1; border-radius: 10px; background: rgba(11, 12, 16, 0.8);
            color: #66fcf1; transition: 0.3s; box-shadow: 0 0 10px rgba(102, 252, 241, 0.2);
        }
        button:hover:not(:disabled) { background: #66fcf1; color: #0b0c10; box-shadow: 0 0 20px #66fcf1; }
        button:disabled { border-color: #555; color: #555; cursor: not-allowed; }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å UI */
        .top-bar {
            position: absolute; top: 15px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .score-board { font-size: 28px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 10px; border: 1px solid #45a29e; }
        .controls { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px; border: 1px solid #45a29e; }
        .controls input[type=range] { cursor: pointer; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 200;
        }
        .modal-content {
            background: #c5c6c7; color: #0b0c10; padding: 40px; border-radius: 15px;
            text-align: center; max-width: 650px; border: 4px solid #45a29e;
        }
        .modal-content h3 { font-size: 34px; color: #d9534f; margin-top: 0; }
        .modal-content p { font-size: 24px; font-weight: bold; }

        /* –£–†–û–í–ï–ù–¨ 1: –§–û–ù–ê–†–ò–ö (–ù–û–í–´–ô –ù–ê–î–ï–ñ–ù–´–ô –ú–ï–¢–û–î) */
        #l1-words-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
        }
        .hidden-word {
            position: absolute; font-size: 45px; font-weight: bold; color: #66fcf1;
            cursor: pointer; padding: 20px; text-shadow: 0 0 15px #45a29e;
        }
        /* –¢—å–º–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å–ª–æ–≤–∞. Pointer-events: none –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–∫–∞—Ç—å —Å–∫–≤–æ–∑—å –Ω–µ—ë */
        #l1-dark-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 3; pointer-events: none;
            transition: background 0.1s;
        }
        .l1-subject { position: absolute; bottom: 40px; width: 100%; text-align: center; font-size: 40px; font-weight: bold; z-index: 5; color: #fff;}
        .l1-hint { position: absolute; top: 140px; width: 100%; text-align: center; font-size: 22px; color: #4ade80; z-index: 5;}

        /* –£–†–û–í–ï–ù–¨ 2: –ó–í–ï–ó–î–û–ü–ê–î –ò –ü–£–®–ö–ê */
        #l2-sky { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: #0b0c10; z-index: 1;}
        .l2-star {
            position: absolute; top: 80px; width: 180px; height: 80px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><polygon points="50,5 61,35 95,35 68,55 78,85 50,70 22,85 32,55 5,35 39,35" fill="%23f1c40f"/></svg>') no-repeat center;
            background-size: contain; display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: bold; color: #000; text-shadow: 0 0 5px #fff;
        }
        #l2-cannon {
            position: absolute; bottom: 20px; left: 600px; width: 80px; height: 100px;
            background: #45a29e; border-radius: 10px 10px 0 0; z-index: 5;
            box-shadow: inset 0 0 20px #0b0c10, 0 0 15px #66fcf1;
        }
        .l2-laser {
            position: absolute; display: none; background: #ff0055;
            width: 20px; height: 60px; border-radius: 10px; box-shadow: 0 0 15px #ff0055; z-index: 4;
        }

        /* –£–†–û–í–ï–ù–¨ 3: –°–ë–û–†–ö–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø */
        #l3-workspace { display: flex; flex-direction: column; align-items: center; width: 100%; z-index: 5;}
        #l3-sentence {
            display: flex; gap: 15px; margin-top: 100px; margin-bottom: 50px;
            min-height: 80px; padding: 20px; border-bottom: 3px dashed #45a29e; width: 800px; justify-content: center;
        }
        .l3-slot { font-size: 34px; font-weight: bold; color: #66fcf1; padding: 10px 20px; background: rgba(69, 162, 158, 0.2); border-radius: 10px;}
        #l3-pool { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 800px;}
        .l3-word {
            font-size: 30px; padding: 15px 30px; background: #1f2833; border: 2px solid #66fcf1;
            border-radius: 15px; cursor: pointer; transition: 0.2s; color: #fff;
        }
        .l3-word:hover { background: #45a29e; transform: scale(1.1); }

        #secret-word-btn { display: none; background: #8e44ad; border-color: #9b59b6; }
    </style>
</head>
<body>

<script>
    (function() {
        const allowedDomains = ['stepik.org', 'welcome.stepik.org'];
        const referrer = document.referrer;
        const isLocal = window.location.protocol === 'file:';
        if (!allowedDomains.some(domain => referrer.includes(domain)) && !isLocal) {
            document.body.innerHTML = `
                <div style="background:#000; color:#fff; height:100vh; display:flex;
                            flex-direction:column; align-items:center; justify-content:center;
                            font-family:sans-serif; text-align:center; padding:20px;">
                    <h1>‚õîÔ∏è –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h1>
                    <p>–≠—Ç–∞ –∏–≥—Ä–∞ ‚Äî —á–∞—Å—Ç—å –ø–ª–∞—Ç–Ω–æ–≥–æ –∫—É—Ä—Å–∞. <br>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –æ–±—É—á–µ–Ω–∏—é –Ω–∞ Stepik.</p>
                </div>`;
            window.stop();
        }
    })();
</script>

<!-- ========================================== -->
<!-- –í–°–¢–ê–í–õ–Ø–¢–¨ –°–°–´–õ–ö–ò –ù–ê –ê–£–î–ò–û –ò–ó GITHUB PAGES –°–Æ–î–ê: -->
<!-- ========================================== -->
<audio id="bg-music" src="https://george-stone-pax.github.io/my-game-assets/Aylex%20-%20Back%20To%20Life%20(freetouse.com).mp3" loop></audio>
<audio id="snd-correct" src="https://george-stone-pax.github.io/my-game-assets/rightanswer-95219.mp3"></audio>
<audio id="snd-wrong" src="https://george-stone-pax.github.io/my-game-assets/dodgeball.mp3"></audio>

<div id="game-wrapper">
    <div id="game-container">
        
        <div class="top-bar">
            <div class="score-board">–ë–∞–ª–ª—ã: <span id="score-display">0</span></div>
            <div class="controls">
                <span style="font-size:20px;">üîä</span>
                <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5">
                <button style="padding: 5px 15px; font-size: 18px; margin:0;" onclick="showHelp()">‚ùì –ö–∞–∫ –∏–≥—Ä–∞—Ç—å</button>
                <button style="padding: 5px 15px; font-size: 18px; margin:0;" onclick="toggleFullscreen()">‚õ∂</button>
            </div>
        </div>

        <div id="screen-menu" class="screen active">
            <h1>Present Simple</h1>
            <button onclick="switchScreen('screen-theory')">üìö –¢–µ–æ—Ä–∏—è</button>
            <button id="btn-start" disabled onclick="startLevel(1)">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É üîí</button>
        </div>

        <div id="screen-theory" class="screen">
            <h2>–ü—Ä–∞–≤–∏–ª–∞ Present Simple</h2>
            <div style="background: rgba(0,0,0,0.6); padding: 30px; border-radius: 15px; max-width: 800px; text-align: left; font-size: 22px;">
                <p><b>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</b> I, you, we, they ‚Äî –æ–±—ã—á–Ω—ã–π –≥–ª–∞–≥–æ–ª (<i>I play</i>). He, she, it ‚Äî –≥–ª–∞–≥–æ–ª —Å –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º <b>-s</b> (<i>He plays</i>).</p>
                <p><b>–û—Ç—Ä–∏—Ü–∞–Ω–∏—è:</b> –ò—Å–ø–æ–ª—å–∑—É–µ–º <b>don't</b> –∏–ª–∏ <b>doesn't</b>. –£ –≥–ª–∞–≥–æ–ª–∞ —É–±–∏—Ä–∞–µ—Ç—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏–µ -s!</p>
                <p><b>–í–æ–ø—Ä–æ—Å—ã:</b> –í –Ω–∞—á–∞–ª–æ —Å—Ç–∞–≤–∏–º <b>Do</b> –∏–ª–∏ <b>Does</b>.</p>
            </div>
            <button onclick="unlockGame()" style="margin-top: 30px;">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>

        <div id="screen-level1" class="screen">
            <h2 style="position: absolute; top: 80px; z-index: 10;">–£—Ä–æ–≤–µ–Ω—å 1: –ü–æ–∏—Å–∫ –≤ —Ç–µ–º–Ω–æ—Ç–µ</h2>
            <div class="l1-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π –ü–†–ê–í–£–Æ –∫–Ω–æ–ø–∫—É –º—ã—à–∏, —á—Ç–æ–±—ã —Å–≤–µ—Ç–∏—Ç—å —Ñ–æ–Ω–∞—Ä–∏–∫–æ–º!</div>
            <div id="l1-words-container"></div>
            <div id="l1-dark-overlay"></div>
            <div class="l1-subject" id="l1-subject"></div>
        </div>

        <div id="screen-level2" class="screen">
            <h2 style="position: absolute; top: 80px; z-index: 10;">–£—Ä–æ–≤–µ–Ω—å 2: –õ–∞–∑–µ—Ä–Ω–∞—è –ø—É—à–∫–∞ (–û—Ç—Ä–∏—Ü–∞–Ω–∏—è)</h2>
            <div class="l1-subject" id="l2-subject" style="bottom: 150px;"></div>
            <div id="l2-sky">
                <div id="l2-stars-container"></div>
                <div id="l2-cannon"></div>
                <div class="l2-laser" id="l2-laser"></div>
            </div>
        </div>

        <div id="screen-level3" class="screen">
            <h2 style="position: absolute; top: 80px; z-index: 10;">–£—Ä–æ–≤–µ–Ω—å 3: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <div id="l3-workspace">
                <div id="l3-sentence"></div>
                <div id="l3-pool"></div>
            </div>
        </div>

        <div id="screen-end" class="screen">
            <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h1>
            <h2>–û—Ü–µ–Ω–∫–∞: <span id="final-grade" style="color: #f1c40f; font-size: 80px;"></span></h2>
            <p style="font-size: 30px;">–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: <span id="final-score">0</span> –∏–∑ 15.</p>
            <div>
                <button onclick="showModal('modal-criteria')">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏</button>
                <button id="secret-word-btn" onclick="showModal('modal-secret')">üóùÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –°–ï–ö–†–ï–¢–ù–û–ï –°–õ–û–í–û</button>
                <button onclick="location.reload()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        </div>

        <div id="modal-error" class="modal-overlay">
            <div class="modal-content">
                <h3>–û—à–∏–±–∫–∞! ‚ùå</h3>
                <p id="error-text"></p>
                <p style="color: red; font-size: 20px;">–®—Ç—Ä–∞—Ñ: -5 –±–∞–ª–ª–æ–≤</p>
                <button onclick="closeError()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>

        <div id="modal-criteria" class="modal-overlay">
            <div class="modal-content">
                <h3>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏</h3>
                <p style="text-align: left; font-size: 20px;">
                    ¬´5¬ª: 13‚Äì15 –±–∞–ª–ª–æ–≤ (85-100%)<br>
                    ¬´4¬ª: 11‚Äì12 –±–∞–ª–ª–æ–≤ (70-84%)<br>
                    ¬´3¬ª: 8‚Äì10 –±–∞–ª–ª–æ–≤ (50-69%)<br>
                    ¬´2¬ª: 0‚Äì7 –±–∞–ª–ª–æ–≤ (–º–µ–Ω–µ–µ 50%)
                </p>
                <button onclick="closeModal('modal-criteria')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="modal-secret" class="modal-overlay">
            <div class="modal-content">
                <h3>–ù–∞–≥—Ä–∞–¥–∞! üèÜ</h3>
                <!-- –ò–ó–ú–ï–ù–ï–ù–ù–û–ï –°–ï–ö–†–ï–¢–ù–û–ï –°–õ–û–í–û -->
                <p style="font-size: 50px; color: #8e44ad; margin: 10px 0;">Sofa - –î–∏–≤–∞–Ω</p>
                <button onclick="closeModal('modal-secret')">–°—É–ø–µ—Ä!</button>
            </div>
        </div>

        <div id="modal-help" class="modal-overlay">
            <div class="modal-content">
                <h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</h3>
                <p id="help-text"></p>
                <button onclick="closeModal('modal-help')">–í –±–æ–π!</button>
            </div>
        </div>

    </div>
</div>

<script>
    // --- –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï ---
    const wrapper = document.getElementById('game-wrapper');
    const container = document.getElementById('game-container');
    function resizeGame() {
        const scale = Math.min(wrapper.clientWidth / 1280, wrapper.clientHeight / 720);
        container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame); resizeGame();

    function toggleFullscreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
        else document.exitFullscreen();
    }

    // –ë–õ–û–ö–ò–†–û–í–ö–ê –°–ö–†–û–õ–õ–ê –ò –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ú–ï–ù–Æ –ë–†–ê–£–ó–ï–†–ê
    window.addEventListener('keydown', e => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(e.code)) e.preventDefault();
    });
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–∑–æ–≤ –º–µ–Ω—é –Ω–∞ –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏, —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –º–µ—à–∞–ª–æ —Ñ–æ–Ω–∞—Ä–∏–∫—É!
    container.addEventListener('contextmenu', e => e.preventDefault());

    // --- –ó–í–£–ö –ò –ì–†–û–ú–ö–û–°–¢–¨ ---
    const bgMusic = document.getElementById('bg-music');
    const sfxCorrect = document.getElementById('snd-correct');
    const sfxWrong = document.getElementById('snd-wrong');
    document.getElementById('vol').addEventListener('input', e => {
        let v = e.target.value; bgMusic.volume = v; sfxCorrect.volume = v; sfxWrong.volume = v;
    });

    function playSfx(type) {
        let s = type === 'correct' ? sfxCorrect : sfxWrong;
        s.currentTime = 0; s.play();
    }

    // --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    let score = 0;
    let currentLevel = 0;
    let questionIndex = 0;
    let isPaused = false;
    let animationFrameId;

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function unlockGame() {
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-start').innerText = "üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
        switchScreen('screen-menu'); bgMusic.play().catch(()=>{});
    }

    function updateScore() { document.getElementById('score-display').innerText = score; }

    function showError(text, callback) {
        isPaused = true; playSfx('wrong');
        score -= 5; updateScore(); 
        document.getElementById('error-text').innerHTML = text;
        showModal('modal-error');
        window.errorCallback = callback;
    }
    function closeError() {
        closeModal('modal-error'); isPaused = false;
        if(window.errorCallback) { let cb = window.errorCallback; window.errorCallback = null; cb(); }
    }

    function showHelp() {
        let txt = "";
        if(currentLevel === 1) txt = "–£–¥–µ—Ä–∂–∏–≤–∞–π –ü–†–ê–í–£–Æ –∫–Ω–æ–ø–∫—É –º—ã—à–∏, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –≥–æ–ª—É–±–æ–π —Ñ–æ–Ω–∞—Ä–∏–∫ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º–Ω–æ—Ç—É. –ù–∞—à–µ–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ? –ö–ª–∏–∫–∞–π –ø–æ –Ω–µ–º—É –õ–ï–í–û–ô –∫–Ω–æ–ø–∫–æ–π, –ø–æ–∫–∞ –¥–µ—Ä–∂–∏—à—å —Ñ–æ–Ω–∞—Ä–∏–∫!";
        if(currentLevel === 2) txt = "–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–µ–ª–æ—á–∫–∏ ‚¨ÖÔ∏è –∏ ‚û°Ô∏è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –ø—É—à–∫–∏. –ù–∞–∂–º–∏ –ü–†–û–ë–ï–õ, —á—Ç–æ–±—ã –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç—å –ª–∞–∑–µ—Ä–æ–º –≤ –∑–≤–µ–∑–¥—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º.";
        if(currentLevel === 3) txt = "–ö–ª–∏–∫–∞–π –ø–æ —Å–ª–æ–≤–∞–º –≤–Ω–∏–∑—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!";
        document.getElementById('help-text').innerText = txt;
        showModal('modal-help');
    }

    function startLevel(lvl) {
        cancelAnimationFrame(animationFrameId); // –°–±—Ä–æ—Å –∞–Ω–∏–º–∞—Ü–∏–π (–Ω–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è)
        currentLevel = lvl; questionIndex = 0; isPaused = false;
        switchScreen(`screen-level${lvl}`);
        showHelp();
        if(lvl === 1) initLevel1();
        else if(lvl === 2) initLevel2();
        else if(lvl === 3) initLevel3();
    }

    // --- –£–†–û–í–ï–ù–¨ 1: –§–û–ù–ê–†–ò–ö –ù–ê –ü–†–ê–í–£–Æ –ö–ù–û–ü–ö–£ ---
    const l1Data = [
        { sub: "The boy (he) ___", correct: "reads", wrong: "read", rule: "–° 'he' –≥–ª–∞–≥–æ–ª —Ç—Ä–µ–±—É–µ—Ç -s!" },
        { sub: "I ___ apples", correct: "like", wrong: "likes", rule: "–° 'I' –æ–∫–æ–Ω—á–∞–Ω–∏–µ -s –Ω–µ –Ω—É–∂–Ω–æ!" },
        { sub: "The cat (it) ___", correct: "jumps", wrong: "jump", rule: "–° 'it' (–∫–æ—Ç) –≥–ª–∞–≥–æ–ª –ø–æ–ª—É—á–∞–µ—Ç -s!" },
        { sub: "We ___ books", correct: "read", wrong: "reads", rule: "–° 'We' –æ–∫–æ–Ω—á–∞–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ!" },
        { sub: "The girl (she) ___", correct: "runs", wrong: "run", rule: "–° 'she' –≥–ª–∞–≥–æ–ª —Ç—Ä–µ–±—É–µ—Ç -s!" }
    ];

    let isRightMouseDown = false;
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏ (button === 2)
    container.addEventListener('mousedown', e => {
        if(e.button === 2 && currentLevel === 1) { 
            isRightMouseDown = true; updateFlashlight(e); 
        }
    });
    window.addEventListener('mouseup', e => {
        if(e.button === 2 && currentLevel === 1) { 
            isRightMouseDown = false; updateFlashlight(e); 
        }
    });
    container.addEventListener('mousemove', e => {
        if(isRightMouseDown && currentLevel === 1) updateFlashlight(e);
    });

    function updateFlashlight(e) {
        const overlay = document.getElementById('l1-dark-overlay');
        if(isRightMouseDown) {
            const rect = container.getBoundingClientRect();
            const scale = rect.width / 1280;
            let x = (e.clientX - rect.left) / scale;
            let y = (e.clientY - rect.top) / scale;
            // –î–µ–ª–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –¥—ã—Ä–∫—É (—Ñ–æ–Ω–∞—Ä–∏–∫ –≥–æ–ª—É–±–æ–≥–æ —Ü–≤–µ—Ç–∞) –≤ —Ç–µ–º–Ω–æ–º —Å–ª–æ–µ
            overlay.style.background = `radial-gradient(circle 180px at ${x}px ${y}px, rgba(0, 195, 255, 0.1) 0%, rgba(0,0,0,0.98) 70%)`;
        } else {
            // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—É—â–µ–Ω–∞ - –ø–æ–ª–Ω–∞—è —Ç–µ–º–Ω–æ—Ç–∞
            overlay.style.background = `rgba(0,0,0,0.98)`;
        }
    }

    function initLevel1() {
        if(questionIndex >= 5) { setTimeout(()=>startLevel(2), 1000); return; }
        let q = l1Data[questionIndex];
        document.getElementById('l1-subject').innerText = q.sub;
        
        const canvas = document.getElementById('l1-words-container');
        canvas.innerHTML = '';
        
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–ª–æ–≤–∞ –Ω–µ –Ω–∞–ª–æ–∂–∞—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã –ø–æ X)
        let words = [q.correct, q.wrong].sort(() => Math.random() - 0.5);
        words.forEach((word, i) => {
            let el = document.createElement('div');
            el.className = 'hidden-word'; el.innerText = word;
            
            // –õ–µ–≤–∞—è –∏ –ø—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞, —Å–ª—É—á–∞–π–Ω–∞—è –≤—ã—Å–æ—Ç–∞
            let rx = i === 0 ? 200 + Math.random() * 200 : 700 + Math.random() * 200;
            let ry = 200 + Math.random() * 300;
            
            el.style.left = rx + 'px'; el.style.top = ry + 'px';
            
            el.onclick = () => {
                // –ï—Å–ª–∏ —Ñ–æ–Ω–∞—Ä–∏–∫ –Ω–µ –≥–æ—Ä–∏—Ç - –Ω–∞–∂–∏–º–∞—Ç—å –Ω–µ–ª—å–∑—è! (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–µ–ø–æ–≥–æ –∫–ª–∏–∫–∞)
                if(isPaused || !isRightMouseDown) return; 
                
                isRightMouseDown = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–Ω–∞—Ä–∏–∫
                updateFlashlight(null);

                if(word === q.correct) {
                    playSfx('correct'); score++; updateScore(); questionIndex++; initLevel1();
                } else {
                    showError(q.rule + "<br><br>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>" + q.correct + "</b>", () => {
                        questionIndex++; initLevel1();
                    });
                }
            };
            canvas.appendChild(el);
        });
    }

    // --- –£–†–û–í–ï–ù–¨ 2: –ü–£–®–ö–ê (–±–µ–∑ —É—Å–∫–æ—Ä–µ–Ω–∏–π) ---
    const l2Data = [
        { sub: "The dogs (they)", correct: "don't", wrong: ["doesn't", "dno't"], rule: "–°–æ–±–∞–∫–∏ (They) –∏—Å–ø–æ–ª—å–∑—É—é—Ç don't." },
        { sub: "The doctor (he)", correct: "doesn't", wrong: ["don't", "deson't"], rule: "–î–æ–∫—Ç–æ—Ä (He) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç doesn't." },
        { sub: "You", correct: "don't", wrong: ["doesn't", "dnot"], rule: "–° 'You' –∏—Å–ø–æ–ª—å–∑—É–µ–º don't." },
        { sub: "My sister (she)", correct: "doesn't", wrong: ["don't", "dsone't"], rule: "–°–µ—Å—Ç—Ä–∞ (She) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç doesn't." },
        { sub: "My friends (they)", correct: "don't", wrong: ["doesn't", "dont'"], rule: "–î—Ä—É–∑—å—è (They) –∏—Å–ø–æ–ª—å–∑—É—é—Ç don't." }
    ];

    let l2PlayerX = 600;
    let l2Keys = { ArrowLeft: false, ArrowRight: false, Space: false };
    let bullet = { active: false, x: 0, y: 0 };
    let starsData = [];

    window.addEventListener('keydown', e => { if(e.code in l2Keys) l2Keys[e.code] = true; });
    window.addEventListener('keyup', e => { if(e.code in l2Keys) l2Keys[e.code] = false; });

    function initLevel2() {
        if(questionIndex >= 5) { cancelAnimationFrame(animationFrameId); setTimeout(()=>startLevel(3), 1000); return; }
        
        bullet.active = false; document.getElementById('l2-laser').style.display = 'none';
        document.getElementById('l2-subject').innerText = l2Data[questionIndex].sub;
        
        const container = document.getElementById('l2-stars-container');
        container.innerHTML = ''; starsData = [];
        
        let q = l2Data[questionIndex];
        let words = [q.correct, q.wrong[0], q.wrong[1]].sort(()=>Math.random() - 0.5);
        let positions = [200, 550, 900]; // –°—Ç—Ä–æ–≥–æ 3 –ø–æ–∑–∏—Ü–∏–∏ —Å–≤–µ—Ä—Ö—É
        
        words.forEach((w, i) => {
            let el = document.createElement('div');
            el.className = 'l2-star'; el.innerText = w;
            el.style.left = positions[i] + 'px';
            container.appendChild(el);
            starsData.push({ el: el, text: w, x: positions[i], y: 80, width: 180, height: 80 });
        });
        
        cancelAnimationFrame(animationFrameId); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—à–ª—ã–π —Ü–∏–∫–ª, —á—Ç–æ–±—ã —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ —Ä–æ—Å–ª–∞
        loopL2();
    }

    function loopL2() {
        if(currentLevel !== 2 || isPaused) { animationFrameId = requestAnimationFrame(loopL2); return; }
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –ø—É—à–∫–∏
        if(l2Keys.ArrowLeft) l2PlayerX -= 10;
        if(l2Keys.ArrowRight) l2PlayerX += 10;
        if(l2PlayerX < 0) l2PlayerX = 0;
        if(l2PlayerX > 1200) l2PlayerX = 1200;
        document.getElementById('l2-cannon').style.left = l2PlayerX + 'px';

        // –í—ã—Å—Ç—Ä–µ–ª
        if(l2Keys.Space && !bullet.active) {
            bullet.active = true;
            bullet.x = l2PlayerX + 30; // –¶–µ–Ω—Ç—Ä –ø—É—à–∫–∏
            bullet.y = 580; // –ù–∞—á–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø—É—à–∫–∏
            let bEl = document.getElementById('l2-laser');
            bEl.style.display = 'block'; bEl.style.left = bullet.x + 'px';
        }

        // –î–≤–∏–∂–µ–Ω–∏–µ –ª–∞–∑–µ—Ä–∞
        if(bullet.active) {
            bullet.y -= 7; 
            let bEl = document.getElementById('l2-laser');
            bEl.style.top = bullet.y + 'px';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø–æ –∑–≤–µ–∑–¥–∞–º
            starsData.forEach(star => {
                if (bullet.x < star.x + star.width && bullet.x + 20 > star.x &&
                    bullet.y < star.y + star.height && bullet.y + 60 > star.y) {
                    
                    bullet.active = false; bEl.style.display = 'none';
                    checkL2Shoot(star.text, l2Data[questionIndex]);
                }
            });

            if(bullet.y < 0) { bullet.active = false; bEl.style.display = 'none'; }
        }

        animationFrameId = requestAnimationFrame(loopL2);
    }

    function checkL2Shoot(shotText, q) {
        if(shotText === q.correct) {
            playSfx('correct'); score++; updateScore(); questionIndex++;
            setTimeout(initLevel2, 500);
        } else {
            let msg = `–¢—ã –ø–æ–¥–±–∏–ª –Ω–µ —Ç—É –∑–≤–µ–∑–¥—É: ${shotText}. `;
            if(q.wrong.includes(shotText) && shotText.length === q.correct.length && shotText !== q.wrong[0]) {
                msg = `–≠—Ç–æ –∑–≤–µ–∑–¥–∞-–æ–±–º–∞–Ω–∫–∞ —Å –ø–µ—Ä–µ–ø—É—Ç–∞–Ω–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏: ${shotText}. `;
            }
            showError(msg + "<br>" + q.rule + "<br>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>" + q.correct + "</b>", () => {
                questionIndex++; initLevel2();
            });
        }
    }

    // --- –£–†–û–í–ï–ù–¨ 3: –ö–û–ù–°–¢–†–£–ö–¢–û–† –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø ---
    const l3Data = [
        { q: "Does he play chess ?", words: ["he", "play", "Does", "chess", "?"] },
        { q: "Do they like pizza ?", words: ["like", "?", "they", "Do", "pizza"] },
        { q: "Does she read books ?", words: ["books", "she", "?", "read", "Does"] },
        { q: "Do we go home ?", words: ["home", "we", "Do", "?", "go"] },
        { q: "Does it fly high ?", words: ["high", "fly", "Does", "?", "it"] }
    ];

    let l3Target = [];
    let l3Current = [];

    function initLevel3() {
        if(questionIndex >= 5) { finishGame(); return; }
        let currentQ = l3Data[questionIndex];
        l3Target = currentQ.q.split(" ");
        l3Current = [];
        renderL3();
    }

    function renderL3() {
        let sentContainer = document.getElementById('l3-sentence');
        let poolContainer = document.getElementById('l3-pool');
        sentContainer.innerHTML = ''; poolContainer.innerHTML = '';

        l3Target.forEach((w, i) => {
            let slot = document.createElement('div');
            slot.className = 'l3-slot';
            slot.innerText = l3Current[i] ? l3Current[i] : "___";
            sentContainer.appendChild(slot);
        });

        let availableWords = l3Data[questionIndex].words.filter(w => !l3Current.includes(w));
        availableWords.forEach(w => {
            let btn = document.createElement('div');
            btn.className = 'l3-word'; btn.innerText = w;
            btn.onclick = () => {
                if(isPaused) return;
                checkL3Word(w);
            };
            poolContainer.appendChild(btn);
        });
    }

    function checkL3Word(word) {
        let expectedWord = l3Target[l3Current.length];
        if(word === expectedWord) {
            playSfx('correct'); l3Current.push(word); renderL3();
            if(l3Current.length === l3Target.length) {
                score++; updateScore(); questionIndex++;
                setTimeout(initLevel3, 1000);
            }
        } else {
            let rule = l3Target[0] === "Does" ? "–í–æ–ø—Ä–æ—Å —Å He/She/It –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å Does!" : "–í–æ–ø—Ä–æ—Å —Å I/You/We/They –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å Do!";
            showError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤!<br>" + rule, () => {
                l3Current = []; renderL3();
            });
        }
    }

    // --- –§–ò–ù–ê–õ ---
    function finishGame() {
        switchScreen('screen-end');
        document.getElementById('final-score').innerText = score;
        
        let grade = "2";
        if(score >= 13) grade = "5";
        else if(score >= 11) grade = "4";
        else if(score >= 8) grade = "3";
        
        document.getElementById('final-grade').innerText = grade;
        if(grade === "5") document.getElementById('secret-word-btn').style.display = 'inline-block';
    }
</script>
</body>
</html>
